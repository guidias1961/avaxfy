<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Avaxfy – Stream Your Music on Avalanche</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <style>
    /* ... (mantém exatamente o CSS de antes) ... */
    .modal-backdrop { display: none; }
    .modal-backdrop.active { display: flex; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Avaxfy</h1>
    <nav>
      <button onclick="showSection('home')" id="nav-home" class="active">Home</button>
      <button onclick="showSection('favorites')" id="nav-fav">Favorites</button>
      <button type="button" onclick="toggleUpload()">Upload</button>
    </nav>
    <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
    <span id="walletAddress"></span>
  </div>

  <div id="main">
    <header>
      <input id="searchBar" placeholder="Search…" oninput="filterTracks()">
    </header>
    <div id="contentArea"></div>
  </div>

  <!-- PLAYER BAR -->
  <div id="playerBar">…</div>

  <!-- UPLOAD MODAL -->
  <div id="uploadModal" class="modal-backdrop">
    <div class="modal">
      <h2>Upload Your Track</h2>
      <input id="trackTitle" placeholder="Track Title">
      <input id="trackArtist" placeholder="Artist Name">
      <input type="file" id="trackFile" accept="audio/*">
      <input type="file" id="coverFile" accept="image/*">
      <input id="supportWallet" placeholder="Your support wallet">
      <button class="confirm" onclick="uploadTrack()">Pay & Upload (0.1 AVAX)</button>
      <button class="cancel" onclick="toggleModal('uploadModal', false)">Cancel</button>
    </div>
  </div>
  <!-- SUPPORT & SUPPORTERS MODALS -->
  <div id="supportModal" class="modal-backdrop">…</div>
  <div id="supportersModal" class="modal-backdrop">…</div>

  <audio id="audio"></audio>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@storacha/client/dist/index.esm.min.js';

  const DEFAULT_SUPPORT_WALLET = '0x730c82D501Ec341E376F95b9B5D48a059dABc218';
  const STORAGE_KEY = 'avaxfy_favorites';
  const SPACE_DID    = 'did:key:z6Mkfzfmr6k4WgvQcFtyKyzsLBGzBLJN2LREYeo4DcmHF4df';
  const LOGIN_EMAIL  = 'guidias1961@gmail.com';

  let provider, signer, userAccount, client;
  let currentSection = 'home', currentIndex = 0;
  let tracks = [], favorites = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');

  (async()=>{
    client = await createClient();
    await client.login(LOGIN_EMAIL);
    await client.setCurrentSpace(SPACE_DID);
  })();

  async function connectWallet() {
    if(!window.ethereum) return alert('Install MetaMask');
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    userAccount = await signer.getAddress();
    document.getElementById('walletAddress').textContent = userAccount;
  }

  function toggleModal(id, show=true) {
    document.getElementById(id).classList.toggle('active', show);
  }
  function toggleUpload() {
    if(!signer) return alert('Connect wallet first');
    toggleModal('uploadModal', true);
  }

  function formatTime(s) {
    const m = Math.floor(s/60), sec = Math.floor(s%60);
    return `${m}:${sec<10?'0':''}${sec}`;
  }

  function totalSupport(t) {
    return t.supporters.reduce((sum,x)=>sum+Number(x.amount),0);
  }
  function sortBySupport(arr) {
    return arr.slice().sort((a,b)=> totalSupport(b) - totalSupport(a));
  }

  function showSection(sec) {
    currentSection = sec;
    document.getElementById('nav-home').classList.toggle('active', sec==='home');
    document.getElementById('nav-fav').classList.toggle('active', sec==='favorites');
    filterTracks();
  }
  function filterTracks() {
    const q = document.getElementById('searchBar').value.toLowerCase();
    let idxs = tracks.map((_,i)=>i);
    if(currentSection==='favorites') idxs = idxs.filter(i=>favorites.includes(i));
    idxs = idxs.filter(i=>{
      const t = tracks[i];
      return t.title.toLowerCase().includes(q) || t.artist.toLowerCase().includes(q);
    });
    renderTracks(sortBySupport(idxs));
  }
  function renderTracks(list) {
    const area = document.getElementById('contentArea');
    area.innerHTML = '';
    list.forEach((i,pos)=>{
      const t = tracks[i], tot = totalSupport(t).toFixed(4);
      const d = document.createElement('div'); d.className='track';
      d.innerHTML = `
        <div class="rank">#${pos+1}</div>
        <img src="${t.cover}" alt="Cover">
        <div class="track-info">
          <span>${t.title}</span><span>${t.artist}</span>
          <span class="total-supported">Supported: ${tot} AVAX</span>
        </div>
        <span class="material-icons favorite-icon"
          onclick="(e=>{e.stopPropagation();toggleFavorite(${i})})(event)">
          ${favorites.includes(i)?'favorite':'favorite_border'}
        </span>
        <button class="support-btn" onclick="(e=>{e.stopPropagation();openSupportModal(${i})})(event)">
          Support
        </button>
        <button class="view-supporters-btn" onclick="(e=>{e.stopPropagation();openSupportersModal(${i})})(event)">
          View Supporters
        </button>`;
      d.onclick = ()=>playTrack(i);
      area.appendChild(d);
    });
  }

  function toggleFavorite(i) {
    const p = favorites.indexOf(i);
    if(p>=0) favorites.splice(p,1);
    else favorites.push(i);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(favorites));
    showSection(currentSection);
  }

  const audio = document.getElementById('audio');
  function playTrack(i) {
    currentIndex = i; const t = tracks[i];
    audio.src = t.url;
    document.getElementById('currentCover').src = t.cover;
    document.getElementById('currentTitle').textContent = t.title;
    document.getElementById('currentArtist').textContent = t.artist;
    audio.onloadedmetadata = ()=> document.getElementById('totalTime').textContent = formatTime(audio.duration);
    audio.play();
    document.getElementById('playPause').innerHTML = '<span class="material-icons">pause</span>';
  }
  function togglePlay() {
    if(audio.paused) { audio.play(); toggleIcon('pause'); }
    else { audio.pause(); toggleIcon('play_arrow'); }
  }
  function toggleIcon(icon) {
    document.getElementById('playPause').innerHTML = `<span class="material-icons">${icon}</span>`;
  }
  function prevTrack(){ playTrack((currentIndex-1+tracks.length)%tracks.length); }
  function nextTrack(){ playTrack((currentIndex+1)%tracks.length); }
  function seekTrack(v) {
    if(!audio.duration) return;
    audio.currentTime = v/100*audio.duration;
    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
  }
  function setVolume(){ audio.volume = document.getElementById('volume').value; }

  async function uploadTrack(){
    const title  = document.getElementById('trackTitle').value;
    const artist = document.getElementById('trackArtist').value;
    const file   = document.getElementById('trackFile').files[0];
    const cover  = document.getElementById('coverFile').files[0];
    const wallet = document.getElementById('supportWallet').value || DEFAULT_SUPPORT_WALLET;

    // pagamento
    const tx = await signer.sendTransaction({ to: DEFAULT_SUPPORT_WALLET, value: ethers.utils.parseEther('0.1') });
    await tx.wait();

    // upload IPFS
    const { cid } = await client.uploadDirectory([ file, cover ], { name: title, maxRetries: 3 });
    const trackURL = `https://dweb.link/ipfs/${cid}/${encodeURIComponent(file.name)}`;
    const coverURL = `https://dweb.link/ipfs/${cid}/${encodeURIComponent(cover.name)}`;

    tracks.push({ title, artist, url: trackURL, cover: coverURL, supportWallet: wallet, supporters: [] });
    toggleModal('uploadModal', false);
    showSection(currentSection);
    playTrack(tracks.length - 1);
  }

  // … funções openSupportModal, confirmSupport, openSupportersModal iguais às anteriores …

  // Initialize
  showSection('home');
  </script>
</body>
</html>
