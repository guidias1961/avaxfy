<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Avaxfy – Stream Your Music on Avalanche</title>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <style>
    /* RESET & BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex; height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d; color: #e0e0e0;
      overflow: hidden;
    }

    /* SIDEBAR */
    #sidebar {
      width: 240px; padding: 20px;
      background: rgba(20,20,20,0.9);
      backdrop-filter: blur(8px);
      display: flex; flex-direction: column; gap: 20px;
      border-right: 1px solid #222;
    }
    #sidebar h1 { font-size: 1.8rem; color: #e84142; }
    #sidebar nav a {
      display: block; padding: 10px 0;
      color: #bbb; cursor: pointer;
      text-decoration: none; transition: color .2s;
    }
    #sidebar nav a.active,
    #sidebar nav a:hover {
      color: #e84142;
    }
    #connectWallet {
      margin-top: auto; padding: 10px;
      background: #e84142; border: none; color: #fff;
      font-weight: bold; border-radius: 4px;
      cursor: pointer; transition: background .2s;
    }
    #connectWallet:hover { background: #b81b23; }
    #walletAddress {
      font-size: 0.8rem; margin-top: 5px;
      word-break: break-all;
    }

    /* MAIN & SEARCH */
    #main {
      flex: 1; display: flex; flex-direction: column;
    }
    header {
      padding: 20px; background: rgba(20,20,20,0.9);
      border-bottom: 1px solid #222;
    }
    #searchBar {
      width: 100%; padding: 10px 15px;
      background: #111; border: none; color: #eee;
      font-size: 1rem; border-radius: 4px;
    }
    #contentArea {
      flex: 1; overflow-y: auto; padding: 20px;
      background: #121212; padding-bottom: 100px;
    }

    /* TRACK LIST */
    .track {
      display: flex; align-items: center; gap: 15px;
      padding: 10px; border-radius: 6px; margin-bottom: 15px;
      cursor: pointer; transition: background .2s;
    }
    .track:hover { background: rgba(232,65,66,0.1); }
    .track img {
      width: 50px; height: 50px; object-fit: cover;
      border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .track-info { flex: 1; }
    .track-info span { display: block; line-height: 1.2; }
    .track-info span:first-child { font-weight: bold; }
    .track-info .total-supported {
      font-size: 0.85rem; color: #aaa; margin-top: 4px;
    }
    .rank {
      font-size: 0.9rem; width: 24px; text-align: center;
      color: #e84142; font-weight: bold;
    }
    .favorite-icon {
      font-size: 24px; color: #e84142;
      cursor: pointer; user-select: none;
    }
    .support-btn, .view-supporters-btn {
      background: #e84142; border: none; color: #fff;
      padding: 6px 10px; border-radius: 4px;
      cursor: pointer; font-size: 0.8rem;
      transition: background .2s; margin-left: 5px;
    }
    .support-btn:hover, .view-supporters-btn:hover {
      background: #b81b23;
    }

    /* PLAYER BAR */
    #playerBar {
      position: fixed; bottom: 0; left: 0;
      width: 100%; height: 80px;
      background: rgba(20,20,20,0.8);
      backdrop-filter: blur(10px);
      border-top: 1px solid #222;
      display: flex; align-items: center;
      padding: 0 20px; gap: 20px;
    }
    #currentCover {
      width: 60px; height: 60px;
      border-radius: 6px; object-fit: cover;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
    }
    #playerControls {
      flex: 1; display: flex; align-items: center; gap: 20px;
    }
    #playerControls button {
      background: none; border: none;
      font-size: 28px; color: #eee;
      cursor: pointer; transition: transform .15s, color .15s;
    }
    #playerControls button:hover {
      transform: scale(1.2); color: #e84142;
    }
    .progress-container {
      flex: 1; display: flex; flex-direction: column; gap: 4px;
    }
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 4px;
      background: #333; border-radius: 2px; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 12px; height: 12px;
      border-radius: 50%; background: #e84142;
      box-shadow: 0 0 6px rgba(232,65,66,0.7);
      cursor: pointer;
    }
    .time-display {
      display: flex; justify-content: space-between;
      font-size: 11px; color: #888;
    }
    #volume { width: 100px; }
    #trackInfo {
      display: flex; flex-direction: column; align-items: flex-end;
      gap: 4px; max-width: 200px;
    }
    #currentTitle { font-weight: bold; color: #fff; }
    #currentArtist { font-size: 0.85rem; color: #aaa; }

    /* MODALS */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center;
    }
    .modal-backdrop.active { display: flex; }
    .modal {
      background: #171717; padding: 30px; border-radius: 8px;
      width: 320px; display: flex; flex-direction: column; gap: 15px;
    }
    .modal h2 { color: #e84142; margin-bottom: 10px; }
    .modal input[type="text"],
    .modal input[type="file"],
    .modal input[type="number"] {
      padding: 8px; background: #121212; border: none;
      border-radius: 4px; color: #eee;
    }
    .modal button {
      padding: 10px; border: none; border-radius: 4px;
      cursor: pointer; transition: background .2s;
    }
    .modal button.confirm { background: #e84142; color: #fff; }
    .modal button.confirm:hover { background: #b81b23; }
    .modal button.cancel { background: #333; color: #eee; }

    /* SUPPORTERS TABLE */
    #supportersTable {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    #supportersTable th, #supportersTable td {
      border: 1px solid #333; padding: 6px;
      font-size: 0.85rem; text-align: left;
    }
    #supportersTable th { background: #222; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Avaxfy</h1>
    <nav>
      <a id="nav-home" class="active" onclick="showSection('home')">Home</a>
      <a id="nav-fav" onclick="showSection('favorites')">Favorites</a>
      <a onclick="toggleUpload()">Upload</a>
    </nav>
    <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
    <span id="walletAddress"></span>
  </div>

  <div id="main">
    <header>
      <input id="searchBar" type="text" placeholder="Search…" oninput="filterTracks()">
    </header>
    <div id="contentArea"></div>
  </div>

  <!-- PLAYER BAR -->
  <div id="playerBar">
    <img id="currentCover" src="" alt="Cover">
    <div id="playerControls">
      <button onclick="prevTrack()"><span class="material-icons">skip_previous</span></button>
      <button onclick="togglePlay()" id="playPause">
        <span class="material-icons">play_arrow</span>
      </button>
      <button onclick="nextTrack()"><span class="material-icons">skip_next</span></button>
      <div class="progress-container">
        <input id="progress" type="range" min="0" max="100" step="0.1" value="0"
               oninput="seekTrack(this.value)" onchange="seekTrack(this.value)">
        <div class="time-display">
          <span id="currentTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1"
             oninput="setVolume()">
    </div>
    <div id="trackInfo">
      <span id="currentTitle"></span>
      <span id="currentArtist"></span>
    </div>
  </div>

  <!-- UPLOAD MODAL -->
  <div id="uploadModal" class="modal-backdrop">
    <div class="modal">
      <h2>Upload Your Track</h2>
      <input type="text" id="trackTitle" placeholder="Track Title" required>
      <input type="text" id="trackArtist" placeholder="Artist Name" required>
      <input type="file" id="trackFile" accept="audio/*" required>
      <input type="file" id="coverFile" accept="image/*" required>
      <input type="text" id="supportWallet" placeholder="Your support wallet" required>
      <button class="confirm" onclick="uploadTrack(event)">Pay & Upload (0.1 AVAX)</button>
      <button class="cancel" id="cancelUpload">Cancel</button>
    </div>
  </div>

  <!-- SUPPORT MODAL -->
  <div id="supportModal" class="modal-backdrop">
    <div class="modal">
      <h2>Support</h2>
      <label>Amount:</label>
      <div>
        <label><input type="radio" name="supportAmt" value="0.1" checked>0.1 AVAX</label>
        <label><input type="radio" name="supportAmt" value="0.5">0.5 AVAX</label>
        <label><input type="radio" name="supportAmt" value="custom">Custom</label>
      </div>
      <input id="customSupportAmt" type="number" placeholder="Enter amount" step="0.0001" min="0">
      <button class="confirm" onclick="confirmSupport(event)">Send</button>
      <button class="cancel" onclick="cancelSupport()">Cancel</button>
    </div>
  </div>

  <!-- SUPPORTERS MODAL -->
  <div id="supportersModal" class="modal-backdrop">
    <div class="modal">
      <h2>Supporters</h2>
      <table id="supportersTable">
        <thead>
          <tr><th>Wallet</th><th>Amount (AVAX)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="cancel" onclick="toggleModal('supportersModal', false)">Close</button>
    </div>
  </div>

  <audio id="audio"></audio>

  <script>
    const DEFAULT_SUPPORT_WALLET = '0x730c82D501Ec341E376F95b9B5D48a059dABc218';
    const STORAGE_KEY = 'avaxfy_favorites';

    let provider, signer, userAccount;
    let currentSection = 'home';
    let currentIndex = 0, isSeeking = false;
    let pendingTrackIndex = null;
    let favorites = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    const tracks = [
      { title:"AVAX Roadtrip",        artist:"Various", url:"tracks/2010s roadtrip.mp3",    cover:"covers/2010s roadtrip.jpg",    supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"TokenTok Funk",        artist:"Various", url:"tracks/tiktok funk.mp3",         cover:"covers/tiktok funk.jpg",         supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"AVAX Drop (EDM)",      artist:"Various", url:"tracks/edm.mp3",                 cover:"covers/edm.jpg",                 supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Dust Echo Consensus",  artist:"Various", url:"tracks/dust e echoes.mp3",     cover:"covers/dust e echoes.jpg",     supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Genesis Rock",         artist:"Various", url:"tracks/vintage rock.mp3",      cover:"covers/vintage rock.jpg",      supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"TransACtion Trance",   artist:"Various", url:"tracks/trance.mp3",            cover:"covers/trance.jpg",            supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"ElectroNode",          artist:"Various", url:"tracks/Eletronic.mp3",         cover:"covers/Eletronic.jpg",         supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Smoke & Stake Chill",  artist:"Various", url:"tracks/Smoke and Chill.mp3",   cover:"covers/smoke and chill.jpg",   supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Progressive Protocol", artist:"Various", url:"tracks/progressive.mp3",       cover:"covers/progressive.jpg",       supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Chain Reaction",       artist:"Various", url:"tracks/blockchain.mp3",        cover:"covers/blockchain.jpg",        supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Mountain Consensus",   artist:"Various", url:"tracks/mountain.mp3",          cover:"covers/mountain.jpg",          supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] },
      { title:"Sunset on AVAX",       artist:"Various", url:"tracks/sunset.mp3",            cover:"covers/sunset.jpg",            supportWallet:DEFAULT_SUPPORT_WALLET, supporters:[] }
    ];

    // ← NOVAS FUNÇÕES: cálculo e ordenação por suporte
    function totalSupport(i) {
      return tracks[i].supporters
        .reduce((sum,s)=>sum+Number(s.amount), 0);
    }
    function sortBySupport(list) {
      return list.slice()
        .sort((a,b)=> totalSupport(b) - totalSupport(a));
    }

    /* CONNECT WALLET */
    async function connectWallet() {
      if (!window.ethereum) return alert('Please install MetaMask');
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      userAccount = await signer.getAddress();
      document.getElementById('walletAddress').textContent = userAccount;
    }

    /* FORMAT TIME */
    function formatTime(sec) {
      const m=Math.floor(sec/60), s=Math.floor(sec%60);
      return `${m}:${s<10?'0':''}${s}`;
    }

    /* RENDER TRACKS (mostra também a posição/rank) */
    function renderTracks(list) {
      const area = document.getElementById('contentArea');
      area.innerHTML = '';
      list.forEach((idx, pos) => {
        const t = tracks[idx];
        const total = totalSupport(idx).toFixed(4);
        const div = document.createElement('div');
        div.className = 'track';
        div.innerHTML = `
          <div class="rank">#${pos+1}</div>
          <img src="${encodeURI(t.cover)}" alt="Cover">
          <div class="track-info">
            <span>${t.title}</span>
            <span>${t.artist}</span>
            <span class="total-supported">Supported: ${total} AVAX</span>
          </div>
          <span class="material-icons favorite-icon"
                onclick="toggleFavorite(${idx}); event.stopPropagation();">
            ${favorites.includes(idx)?'favorite':'favorite_border'}
          </span>
          <button class="support-btn"
                  onclick="openSupportModal(${idx}); event.stopPropagation();">
            Support
          </button>
          <button class="view-supporters-btn"
                  onclick="openSupportersModal(${idx}); event.stopPropagation();">
            View Supporters
          </button>`;
        div.onclick = ()=>playTrack(idx);
        area.appendChild(div);
      });
    }

    /* NAVIGATION (agora ordena por suporte) */
    function showSection(sec) {
      currentSection = sec;
      document.getElementById('nav-home')
        .classList.toggle('active', sec==='home');
      document.getElementById('nav-fav')
        .classList.toggle('active', sec==='favorites');
      document.getElementById('searchBar').value = '';
      const base = sec==='favorites'
        ? favorites.slice()
        : tracks.map((_,i)=>i);
      const ordered = sortBySupport(base);
      renderTracks(ordered);
    }

    function filterTracks() {
      const q = document.getElementById('searchBar')
                      .value.toLowerCase();
      const base = currentSection==='favorites'
        ? favorites.slice()
        : tracks.map((_,i)=>i);
      const filtered = base.filter(i=>
        tracks[i].title.toLowerCase().includes(q) ||
        tracks[i].artist.toLowerCase().includes(q)
      );
      const ordered = sortBySupport(filtered);
      renderTracks(ordered);
    }

    function toggleFavorite(idx) {
      const p = favorites.indexOf(idx);
      p>=0 ? favorites.splice(p,1) : favorites.push(idx);
      localStorage.setItem(STORAGE_KEY,
        JSON.stringify(favorites));
      showSection(currentSection);
    }

    /* PLAYER */
    const audio = document.getElementById('audio');
    function playTrack(i) {
      currentIndex=i;
      const t=tracks[i];
      audio.src=encodeURI(t.url);
      document.getElementById('currentCover')
              .src=encodeURI(t.cover);
      document.getElementById('currentTitle')
              .textContent=t.title;
      document.getElementById('currentArtist')
              .textContent=t.artist;
      audio.onloadedmetadata=()=>{
        document.getElementById('totalTime')
                .textContent=formatTime(audio.duration);
      };
      audio.play();
      document.getElementById('playPause')
        .innerHTML='<span class="material-icons">pause</span>';
    }
    function togglePlay() {
      if(audio.paused){
        audio.play();
        document.getElementById('playPause')
          .innerHTML='<span class="material-icons">pause</span>';
      } else {
        audio.pause();
        document.getElementById('playPause')
          .innerHTML='<span class="material-icons">play_arrow</span>';
      }
    }
    function prevTrack(){ playTrack((currentIndex-1+tracks.length)%tracks.length); }
    function nextTrack(){ playTrack((currentIndex+1)%tracks.length); }
    function seekTrack(v){
      if(!audio.duration) return;
      audio.currentTime=(v/100)*audio.duration;
      document.getElementById('currentTime')
        .textContent=formatTime(audio.currentTime);
    }
    function setVolume(){
      audio.volume=document.getElementById('volume').value;
    }
    audio.ontimeupdate=()=>{
      if(!isSeeking && audio.duration){
        const pct=(audio.currentTime/audio.duration)*100;
        document.getElementById('progress').value=pct;
        document.getElementById('currentTime')
          .textContent=formatTime(audio.currentTime);
      }
    };

    /* UPLOAD */
    document.getElementById('cancelUpload')
      .onclick=()=>toggleModal('uploadModal',false);
    function toggleUpload(){
      if(!signer) return alert('Connect your wallet first');
      toggleModal('uploadModal',true);
    }
    async function uploadTrack(e){
      e.preventDefault();
      const title=document.getElementById('trackTitle').value;
      const artist=document.getElementById('trackArtist').value;
      const file=document.getElementById('trackFile').files[0];
      const cover=document.getElementById('coverFile').files[0];
      const wallet=document.getElementById('supportWallet').value;
      try{
        const tx=await signer.sendTransaction({
          to:DEFAULT_SUPPORT_WALLET,
          value:ethers.utils.parseEther('0.1')
        });
        alert('Waiting confirmation…'); await tx.wait();
        alert('Uploaded!');
        const trackURL=URL.createObjectURL(file);
        const coverURL=URL.createObjectURL(cover);
        tracks.push({
          title,artist,url:trackURL,cover:coverURL,
          supportWallet:wallet,supporters:[]
        });
        toggleModal('uploadModal',false);
        showSection(currentSection);
      }catch(err){
        console.error(err); alert('Payment failed.');
      }
    }

    /* SUPPORT */
    document.getElementById('supportModal')
      .querySelector('.cancel')
      .onclick=()=>toggleModal('supportModal',false);
    function openSupportModal(i){
      pendingTrackIndex=i;
      toggleModal('supportModal',true);
      document.querySelector('input[name="supportAmt"][value="0.1"]').checked=true;
      document.getElementById('customSupportAmt').value='';
    }
    async function confirmSupport(e){
      e.preventDefault();
      const form=document.supportForm;
      let amt=form.supportAmt.value;
      if(amt==='custom') amt=document.getElementById('customSupportAmt').value;
      if(!amt||isNaN(amt)||Number(amt)<=0) return alert('Enter valid amount');
      const t=tracks[pendingTrackIndex];
      try{
        const tx=await signer.sendTransaction({
          to:t.supportWallet,
          value:ethers.utils.parseEther(amt)
        });
        alert('Sending…'); await tx.wait();
        alert('Thank you for supporting!');
        t.supporters.push({ wallet:userAccount, amount:amt });
        toggleModal('supportModal',false);
        showSection(currentSection);
      }catch(err){
        console.error(err); alert('Support failed.');
      }
    }

    /* VIEW SUPPORTERS */
    document.getElementById('supportersModal')
      .querySelector('.cancel')
      .onclick=()=>toggleModal('supportersModal',false);
    function openSupportersModal(i){
      const tbody=document.getElementById('supportersTable').querySelector('tbody');
      tbody.innerHTML='';
      tracks[i].supporters.forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${s.wallet}</td><td>${parseFloat(s.amount).toFixed(4)}</td>`;
        tbody.appendChild(tr);
      });
      toggleModal('supportersModal',true);
    }

    function toggleModal(id,show){
      document.getElementById(id).classList.toggle('active',show);
    }

    // INITIALIZE
    document.supportForm=document.getElementById('supportModal').querySelector('form')||{supportAmt:[]};
    showSection('home');
  </script>
</body>
</html>
