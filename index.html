<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Manter todo o cabeçalho anterior igual) -->
  <style>
    /* Adicionar estes novos estilos */
    .twitter-handle {
      color: #1DA1F2;
      font-size: 0.85em;
      margin-top: 3px;
      display: flex;
      align-items: center;
    }
    .twitter-handle .material-icons {
      font-size: 1em;
      margin-right: 5px;
    }
    .support-wallet {
      font-size: 0.75em;
      color: #aaa;
      font-family: monospace;
      word-break: break-all;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- (Manter todo o HTML anterior igual até o modal de upload) -->

  <div id="uploadModal" class="modal-backdrop">
    <div class="modal">
      <h2>Upload Your Track</h2>
      <input type="text" id="trackTitle" placeholder="Track Title" required>
      <input type="text" id="trackArtist" placeholder="Artist Name" required>
      <input type="text" id="twitterHandle" placeholder="Your X/Twitter @ (optional)">
      <input type="file" id="trackFile" accept="audio/*" required>
      <input type="file" id="coverFile" accept="image/*">
      <div id="paymentStatus"></div>
      <button class="confirm" onclick="processUpload()">Pay & Upload (0.1 AVAX)</button>
      <button class="cancel" onclick="toggleModal('uploadModal', false)">Cancel</button>
    </div>
  </div>

  <script>
    // Configurações
    const STORACHA_ENDPOINT = "https://console.storacha.network/space/did:key:z6Mkfzfmr6k4WgvQcFtyKyzsLBGzBLJN2LREYeo4DcmHF4df";
    const PAYMENT_WALLET = "0x730c82D501Ec341E376F95b9B5D48a059dABc218";
    const UPLOAD_FEE = ethers.utils.parseEther("0.1"); // 0.1 AVAX

    // Variáveis globais
    let provider;
    let signer;
    let userUploads = JSON.parse(localStorage.getItem('userUploads')) || {};

    // Função para adicionar upload à UI
    function addUploadToUI(upload) {
      const uploadsList = document.getElementById('uploadsList');
      const uploadItem = document.createElement('div');
      uploadItem.className = 'track'; // Usando a classe track existente
      
      uploadItem.innerHTML = `
        <div class="rank">#${Object.keys(userUploads).length}</div>
        <img src="${upload.coverUrl || 'https://via.placeholder.com/50'}" alt="Cover">
        <div class="track-info">
          <span>${upload.title}</span>
          <span>${upload.artist}</span>
          ${upload.twitterHandle ? `
            <div class="twitter-handle">
              <span class="material-icons">tag</span>
              <a href="https://twitter.com/${upload.twitterHandle.replace('@', '')}" target="_blank">
                ${upload.twitterHandle}
              </a>
            </div>
          ` : ''}
          <div class="total-supported">Supported: 0 AVAX</div>
          <div class="support-wallet">Support wallet: ${upload.supportWallet}</div>
        </div>
        <span class="material-icons favorite-icon">favorite_border</span>
        <button class="support-btn" onclick="showSupportModal('${upload.id}')">Support</button>
      `;
      
      uploadsList.prepend(uploadItem);
      document.getElementById('uploadsSection').style.display = 'block';
    }

    // Função para processar upload
    async function uploadToStoracha() {
      const title = document.getElementById('trackTitle').value;
      const artist = document.getElementById('trackArtist').value;
      const twitterHandle = document.getElementById('twitterHandle').value;
      const trackFile = document.getElementById('trackFile').files[0];
      const coverFile = document.getElementById('coverFile').files[0];
      const walletAddress = document.getElementById('walletAddress').textContent;
      
      if (!title || !artist || !trackFile) {
        throw new Error("Please fill all required fields");
      }

      // Criar ID único para o upload
      const uploadId = 'upload_' + Date.now();
      
      // Processar capa (se existir)
      let coverUrl = '';
      if (coverFile) {
        coverUrl = await uploadCoverToStoracha(coverFile, uploadId);
      }

      // Salvar metadados localmente
      userUploads[uploadId] = {
        id: uploadId,
        title,
        artist,
        twitterHandle: twitterHandle ? (twitterHandle.startsWith('@') ? twitterHandle : '@' + twitterHandle) : null,
        supportWallet: walletAddress,
        coverUrl,
        timestamp: new Date().toISOString(),
        supports: []
      };
      
      localStorage.setItem('userUploads', JSON.stringify(userUploads));
      
      // Upload do áudio para Storacha
      const audioUrl = await uploadAudioToStoracha(trackFile, uploadId);
      userUploads[uploadId].audioUrl = audioUrl;
      localStorage.setItem('userUploads', JSON.stringify(userUploads));

      return userUploads[uploadId];
    }

    // Funções auxiliares para upload
    async function uploadAudioToStoracha(file, uploadId) {
      const formData = new FormData();
      formData.append('audio', file);
      formData.append('uploadId', uploadId);
      
      const response = await fetch(STORACHA_ENDPOINT + '/audio', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Audio upload failed');
      const result = await response.json();
      return result.url;
    }

    async function uploadCoverToStoracha(file, uploadId) {
      const formData = new FormData();
      formData.append('cover', file);
      formData.append('uploadId', uploadId);
      
      const response = await fetch(STORACHA_ENDPOINT + '/cover', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Cover upload failed');
      const result = await response.json();
      return result.url;
    }

    // Carregar uploads existentes ao iniciar
    function loadExistingUploads() {
      const uploads = JSON.parse(localStorage.getItem('userUploads')) || {};
      Object.values(uploads).forEach(upload => {
        addUploadToUI(upload);
      });
    }

    // Chamar quando a página carregar
    window.onload = function() {
      loadExistingUploads();
    };

    // (Manter todas as outras funções anteriores iguais)
  </script>
</body>
</html>